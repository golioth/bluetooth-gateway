From 3c9731e9c41388f01d3ccb2ce362d08abbcf87c0 Mon Sep 17 00:00:00 2001
From: Trond Snekvik <trond@golioth.io>
Date: Tue, 8 Apr 2025 17:06:10 +0200
Subject: [PATCH] Pouch blockwise uploads

Signed-off-by: Trond Snekvik <trond@golioth.io>
---
 include/golioth/gateway.h  | 22 ++++++++++++++++++++++
 port/zephyr/CMakeLists.txt |  1 +
 src/gateway.c              | 37 +++++++++++++++++++++++++++++++++++++
 3 files changed, 60 insertions(+)
 create mode 100644 include/golioth/gateway.h
 create mode 100644 src/gateway.c

diff --git a/include/golioth/gateway.h b/include/golioth/gateway.h
new file mode 100644
index 0000000..9b60a8d
--- /dev/null
+++ b/include/golioth/gateway.h
@@ -0,0 +1,22 @@
+/*
+ * Copyright (c) 2024 Golioth, Inc.
+ *
+ * SPDX-License-Identifier: Apache-2.0
+ */
+#pragma once
+
+#include <golioth/golioth_status.h>
+#include <golioth/client.h>
+#include <stdlib.h>
+
+struct blockwise_transfer *golioth_gateway_uplink_start(struct golioth_client *client);
+
+enum golioth_status golioth_gateway_uplink_block(struct blockwise_transfer *ctx,
+                                                 uint32_t block_idx,
+                                                 const uint8_t *buf,
+                                                 size_t buf_len,
+                                                 bool is_last,
+                                                 golioth_set_block_cb_fn set_cb,
+                                                 void *callback_arg);
+
+void golioth_gateway_uplink_finish(struct blockwise_transfer *ctx);
diff --git a/port/zephyr/CMakeLists.txt b/port/zephyr/CMakeLists.txt
index 2b73184..65346e9 100644
--- a/port/zephyr/CMakeLists.txt
+++ b/port/zephyr/CMakeLists.txt
@@ -41,6 +41,7 @@ zephyr_library_sources(
     ../../src/event_group.c
     ../../src/fw_update.c
     ../../src/coap_blockwise.c
+    ../../src/gateway.c
     ../../src/lightdb_state.c
     ../../src/location.c
     ../../src/location_cellular.c
diff --git a/src/gateway.c b/src/gateway.c
new file mode 100644
index 0000000..cbcd1b6
--- /dev/null
+++ b/src/gateway.c
@@ -0,0 +1,37 @@
+/*
+ * Copyright (c) 2024 Golioth, Inc.
+ *
+ * SPDX-License-Identifier: Apache-2.0
+ */
+
+#include <golioth/gateway.h>
+#include "coap_blockwise.h"
+
+struct blockwise_transfer *golioth_gateway_uplink_start(struct golioth_client *client)
+{
+    return golioth_blockwise_upload_start(client, ".pouch", "", GOLIOTH_CONTENT_TYPE_OCTET_STREAM);
+}
+
+enum golioth_status golioth_gateway_uplink_block(struct blockwise_transfer *ctx,
+                                                 uint32_t block_idx,
+                                                 const uint8_t *buf,
+                                                 size_t buf_len,
+                                                 bool is_last,
+                                                 golioth_set_block_cb_fn set_cb,
+                                                 void *callback_arg)
+{
+    return golioth_blockwise_upload_block(ctx,
+                                          block_idx,
+                                          buf,
+                                          buf_len,
+                                          is_last,
+                                          set_cb,
+                                          callback_arg,
+                                          false,
+                                          GOLIOTH_SYS_WAIT_FOREVER);
+}
+
+void golioth_gateway_uplink_finish(struct blockwise_transfer *ctx)
+{
+    golioth_blockwise_upload_finish(ctx);
+}
-- 
2.43.0

